# Архитектура проекта SingBox-UI

## Структура проекта

```
SingBox-UI/
├── main.py                 # Главный файл приложения
├── updater.py              # Утилита обновления (собирается как updater.exe)
├── config/                 # Конфигурация
│   ├── __init__.py
│   └── paths.py           # Пути к файлам и директориям
├── managers/              # Менеджеры данных
│   ├── __init__.py
│   ├── settings.py        # Менеджер настроек
│   └── subscriptions.py   # Менеджер подписок
├── utils/                 # Утилиты
│   ├── __init__.py
│   ├── i18n.py           # Система локализации
│   ├── logger.py         # Логирование
│   └── singbox.py        # Утилиты для работы с SingBox
├── core/                  # Основная логика
│   ├── __init__.py
│   └── downloader.py     # Загрузка SingBox
├── ui/                    # Интерфейс (зарезервировано для будущего)
│   └── __init__.py
├── locales/              # Исходные файлы локализации
│   ├── ru.json           # Русский язык
│   └── en.json           # Английский язык
├── changelog/            # История изменений версий
│   ├── CHANGELOG_v1.0.0.md
│   ├── CHANGELOG_v1.0.1.md
│   ├── CHANGELOG_v1.0.2.md
│   ├── CHANGELOG_v1.0.3.md
│   └── ...
├── data/                 # Данные приложения (создается автоматически)
│   ├── core/             # Ядро SingBox
│   ├── logs/             # Логи
│   ├── locales/          # Файлы локализации (копируются из locales/)
│   └── config.json       # Конфиг
├── SingBox-UI.spec       # Конфигурация PyInstaller для основного приложения
├── updater.spec          # Конфигурация PyInstaller для updater
├── post_build.py         # Скрипт пост-обработки сборки
└── requirements.txt      # Зависимости
```

## Модули

### config/
- **paths.py** - Определение всех путей к файлам и директориям
- Функция `ensure_dirs()` - создание необходимых папок

### managers/
- **settings.py** - Управление настройками приложения
  - Сохранение/загрузка настроек
  - Поддержка языка интерфейса
  
- **subscriptions.py** - Управление подписками
  - CRUD операции с подписками
  - Скачивание конфигов

### utils/
- **i18n.py** - Система локализации
  - Класс `Translator` для работы с переводами
  - Функция `tr()` для получения переводов
  - Поддержка форматирования строк
  - Поддержка пользовательских языков через `_language_name` в файлах локализации
  
- **logger.py** - Система логирования
  - Запись логов в файлы
  - Отладочные логи
  
- **singbox.py** - Утилиты для SingBox
  - Получение версии SingBox
  - Проверка обновлений SingBox и приложения

### core/
- **downloader.py** - Загрузка SingBox
  - Класс `DownloadThread` для загрузки в отдельном потоке
  - Автоматическая установка последней версии

### updater.py
- **UpdaterWindow** - GUI окно updater в стиле приложения
- **UpdateThread** - Поток для выполнения обновления
  - Скачивание обновления с GitHub
  - Остановка процессов приложения
  - Установка обновления с защитой пользовательских данных
  - Запуск обновленного приложения

### locales/
- **ru.json** - Русские переводы
- **en.json** - Английские переводы

## Использование локализации

```python
from utils.i18n import tr, set_language

# Получить перевод
text = tr("home.version")  # "Версия SingBox"

# С параметрами
text = tr("home.installed", version="1.8.0")  # "Установлено: версия 1.8.0"

# Изменить язык
set_language("en")  # Переключить на английский
```

## Добавление нового языка

1. Создайте файл `data/locales/xx.json` (где xx - код языка, например `eng2.json`)
2. Скопируйте структуру из `ru.json` или `en.json`
3. Добавьте поле `"_language_name"` в корень JSON с названием языка (например, `"_language_name": "English (Custom)"`)
4. Переведите все строки
5. Язык будет доступен автоматически в настройках

## Преимущества архитектуры

1. **Модульность** - код разделен на логические модули
2. **Локализация** - легко добавлять новые языки
3. **Расширяемость** - легко добавлять новые функции
4. **Поддерживаемость** - проще находить и исправлять ошибки
5. **Тестируемость** - модули можно тестировать отдельно

## Сборка проекта

### Требования
- Python 3.8+
- PyInstaller 6.0+

### Команда сборки
```bash
# Сборка основного приложения
py -m PyInstaller SingBox-UI.spec --clean --noconfirm

# Сборка updater
py -m PyInstaller updater.spec --clean --noconfirm

# Пост-обработка
py post_build.py
```

### Результат сборки
После сборки в папке `dist/SingBox-UI/` будет:
- `SingBox-UI.exe` - главный исполняемый файл
- `data/locales/` - файлы локализации
- `data/core/` - ядро SingBox (если было включено)
- `data/updater.exe` - утилита обновления

## Разработка

### Запуск в режиме разработки
```bash
python main.py
```

### Структура данных
Все данные приложения хранятся в папке `data/`:
- `data/core/sing-box.exe` - ядро SingBox (не обновляется автоматически)
- `data/logs/` - логи приложения
  - `singbox.log` - логи SingBox
  - `debug.log` - отладочные логи
- `data/locales/` - файлы локализации (обновляются, пользовательские сохраняются)
- `data/config.json` - конфигурация SingBox (скачивается из подписки)
- `data/.subscriptions` - список подписок (JSON, сохраняется при обновлениях)
- `data/.settings` - настройки приложения (JSON, объединяются при обновлениях)
- `data/updater.exe` - утилита обновления (обновляется при обновлениях)

### Система обновлений
- Updater (`updater.py`) - отдельное приложение с GUI
- Выполняет весь процесс обновления: скачивание, установка, перезапуск
- Защищает пользовательские данные: подписки, настройки, ядро, логи
- Объединяет настройки: новые ключи добавляются, существующие сохраняются
