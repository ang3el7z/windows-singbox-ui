name: Build and Release

run-name: SingBox-UI ${{ github.ref_name }}

on:
  push:
    tags:
      - 'v*'  # –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞, –Ω–∞—á–∏–Ω–∞—é—â–µ–≥–æ—Å—è —Å 'v'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Check version and optionally fix mismatch
      shell: pwsh
      run: |
        $TAG_VERSION = "${{ github.ref_name }}" -replace '^v', ''
        $VERSION_FILE = ".version"
        
        if (Test-Path $VERSION_FILE) {
          $CURRENT_VERSION = (Get-Content $VERSION_FILE -Raw).Trim()
        } else {
          $CURRENT_VERSION = ""
        }
        
        Write-Host "üì¶ Current .version file: $CURRENT_VERSION"
        Write-Host "üè∑  Git tag version: $TAG_VERSION"
        
        if ($CURRENT_VERSION -ne $TAG_VERSION) {
          Write-Host "‚ùå Version mismatch detected!"
          Write-Host "‚è≥ Waiting 30 seconds to allow for manual cancellation..."
          Start-Sleep -Seconds 30
          
          Write-Host "üîÅ Updating .version file to match tag..."
          Set-Content -Path $VERSION_FILE -Value $TAG_VERSION -NoNewline
          
          Write-Host "‚úÖ .version file updated."
        } else {
          Write-Host "‚úÖ Version match confirmed."
        }

    - name: Commit updated .version file (if changed)
      shell: pwsh
      run: |
        $TAG_VERSION = "${{ github.ref_name }}" -replace '^v', ''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git diff --exit-code .version
        if ($LASTEXITCODE -eq 0) {
          Write-Host "‚Ñπ No changes to commit."
          exit 0
        }
        
        Write-Host "üì§ Committing updated .version file..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –≤–µ—Ç–∫—É
        $DEFAULT_BRANCH = "main"
        try {
          $REMOTE_HEAD = git symbolic-ref refs/remotes/origin/HEAD 2>$null
          if ($REMOTE_HEAD) {
            $DEFAULT_BRANCH = $REMOTE_HEAD -replace 'refs/remotes/origin/', ''
          }
        } catch {
          Write-Host "‚ö† Could not determine default branch, using 'main'"
        }
        
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # –°–æ–∑–¥–∞–µ–º –≤–µ—Ç–∫—É –¥–ª—è –∫–æ–º–º–∏—Ç–∞
        $BRANCH_NAME = "sync-version-v${TAG_VERSION}"
        git checkout -b $BRANCH_NAME
        git add .version
        git commit -m "github-actions[bot]: sync version with tag v${TAG_VERSION}"
        
        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –≤–µ—Ç–∫—É –∏ –º–µ—Ä–∂–∏–º
        git fetch origin $DEFAULT_BRANCH
        git checkout $DEFAULT_BRANCH
        git merge $BRANCH_NAME --no-edit
        git push origin $DEFAULT_BRANCH
        
        Write-Host "‚úÖ Version synced to $DEFAULT_BRANCH"
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ç–µ–≥—É –¥–ª—è —Å–±–æ—Ä–∫–∏
        git checkout ${{ github.ref_name }}
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è —Å–±–æ—Ä–∫–∏ (—Ç–µ–≥ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é)
        Set-Content -Path ".version" -Value $TAG_VERSION -NoNewline
        Write-Host "‚úÖ Version updated locally for build: $TAG_VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Ensure version is set for build
      shell: pwsh
      run: |
        $TAG_VERSION = "${{ github.ref_name }}" -replace '^v', ''
        Set-Content -Path ".version" -Value $TAG_VERSION -NoNewline
        Write-Host "‚úÖ Version set for build: $TAG_VERSION"
    
    - name: Check required files
      shell: pwsh
      run: |
        Write-Host "Checking required files..."
        if (Test-Path "data/core/sing-box.exe") {
          Write-Host "‚úì sing-box.exe found"
        } else {
          Write-Host "‚úó WARNING: sing-box.exe not found in data/core/"
        }
        if (Test-Path "locales/en.json") {
          Write-Host "‚úì locales/en.json found"
        } else {
          Write-Host "‚úó ERROR: locales/en.json not found"
          exit 1
        }
        if (Test-Path "locales/ru.json") {
          Write-Host "‚úì locales/ru.json found"
        } else {
          Write-Host "‚úó ERROR: locales/ru.json not found"
          exit 1
        }
        if (Test-Path "main/updater.py") {
          Write-Host "‚úì main/updater.py found"
        } else {
          Write-Host "‚úó ERROR: main/updater.py not found"
          exit 1
        }
        
    - name: Build executables (parallel)
      run: |
        python scripts/build_parallel.py --clean-build
      # Note: build_parallel.py automatically runs post_build.py after successful builds
    
    - name: Verify build outputs
      shell: pwsh
      run: |
        Write-Host "Verifying build outputs (after post-build)..."
        if (Test-Path "dist/SingBox-UI/SingBox-UI.exe") {
          Write-Host "‚úì SingBox-UI.exe built successfully"
        } else {
          Write-Host "‚úó ERROR: SingBox-UI.exe not found in dist/SingBox-UI/"
          exit 1
        }
        if (Test-Path "dist/SingBox-UI/data/updater.exe") {
          Write-Host "‚úì updater.exe built successfully"
        } else {
          Write-Host "‚úó ERROR: updater.exe not found in dist/SingBox-UI/data/"
          exit 1
        }
        
    - name: Extract tag and version
      id: extract_info
      shell: pwsh
      run: |
        $tag = "${{ github.ref }}"
        $tagName = $tag -replace "refs/tags/", ""
        $version = $tagName -replace "^v", ""
        Write-Host "Tag: $tagName"
        Write-Host "Version: $version"
        "tag_name=$tagName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        
    - name: Create archive
      id: create_archive
      shell: pwsh
      run: |
        $version = "${{ steps.extract_info.outputs.version }}"
        Write-Host "Received version from previous step: '$version'"
        if ([string]::IsNullOrEmpty($version)) {
          Write-Host "ERROR: Version is empty!"
          exit 1
        }
        $archiveName = "windows-singbox-ui-v-$version.zip"
        $archivePath = Join-Path $PWD $archiveName
        Write-Host "Creating archive: $archivePath"
        Compress-Archive -Path "dist\SingBox-UI\*" -DestinationPath $archivePath -Force
        Write-Host "Created archive: $archivePath"
        if (Test-Path $archivePath) {
          $fileSize = (Get-Item $archivePath).Length
          Write-Host "Archive exists: $archivePath ($fileSize bytes)"
        } else {
          Write-Host "ERROR: Archive not found at $archivePath"
          exit 1
        }
        "archive_name=$archiveName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        
    - name: Upload artifact to existing release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.create_archive.outputs.archive_name }}
        tag_name: ${{ steps.extract_info.outputs.tag_name }}
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

