# Архитектура проекта SingBox-UI

## Структура проекта

```
SingBox-UI/
├── .version                # Файл версии приложения (читается при запуске)
├── main/                   # Основные файлы приложения
│   ├── main.py            # Главный файл приложения (управление окном и координация)
│   ├── updater.py         # Утилита обновления (собирается как updater.exe)
│   └── post_build.py      # Скрипт пост-обработки сборки
├── icons/                  # Иконки приложения
│   ├── icon.ico           # Иконка Windows
│   ├── icon.png           # PNG иконка
│   └── icon.svg           # SVG иконка (исходник)
├── scripts/                # Утилитарные скрипты
│   └── register_protocol.py # Скрипт регистрации протоколов
├── config/                 # Конфигурация
│   ├── __init__.py
│   └── paths.py           # Пути к файлам и директориям
├── managers/              # Менеджеры данных
│   ├── __init__.py
│   ├── settings.py        # Менеджер настроек
│   ├── subscriptions.py   # Менеджер подписок
│   └── log_ui_manager.py  # Менеджер логов для UI
├── utils/                 # Утилиты
│   ├── __init__.py
│   ├── i18n.py           # Система локализации
│   ├── logger.py         # Логирование
│   └── singbox.py        # Утилиты для работы с SingBox
├── core/                  # Основная логика
│   ├── __init__.py
│   ├── protocol.py       # Регистрация протоколов и работа с правами администратора
│   ├── singbox_manager.py # Управление процессом SingBox
│   └── deep_link_handler.py # Обработчик deep links
├── app/                   # Инициализация приложения
│   ├── __init__.py
│   └── application.py    # Создание QApplication и применение темы
├── workers/               # Фоновые потоки
│   ├── __init__.py
│   ├── base_worker.py    # Базовый класс для воркеров
│   ├── init_worker.py    # Воркер инициализации (загрузка подписок, версий)
│   └── version_worker.py # Воркеры проверки версий
├── ui/                    # Интерфейс пользователя
│   ├── __init__.py
│   ├── pages/            # Страницы приложения
│   │   ├── __init__.py
│   │   ├── base_page.py  # Базовый класс для страниц
│   │   ├── profile_page.py # Страница управления профилями
│   │   ├── home_page.py  # Главная страница
│   │   └── settings_page.py # Страница настроек
│   ├── widgets/          # Переиспользуемые виджеты
│   │   ├── __init__.py
│   │   ├── card.py       # Виджет-карточка
│   │   ├── nav_button.py # Кнопка навигации
│   │   └── version_label.py # Лейбл версии
│   ├── styles/           # Система стилей
│   │   ├── __init__.py
│   │   ├── constants.py  # Константы (цвета, шрифты, размеры)
│   │   ├── theme.py      # Управление темой
│   │   └── stylesheet.py # Генерация стилей для виджетов
│   ├── dialogs/          # Диалоговые окна
│   │   ├── __init__.py
│   │   ├── base_dialog.py # Базовый класс для диалогов
│   │   ├── confirm_dialog.py # Диалоги подтверждения
│   │   ├── info_dialog.py # Информационные диалоги
│   │   └── language_dialog.py # Диалог выбора языка
│   └── tray_manager.py   # Менеджер системного трея
├── locales/              # Исходные файлы локализации
│   ├── ru.json           # Русский язык
│   └── en.json           # Английский язык
├── changelog/            # История изменений версий
│   ├── CHANGELOG_v1.0.0.md
│   ├── CHANGELOG_v1.0.1.md
│   ├── CHANGELOG_v1.0.2.md
│   ├── CHANGELOG_v1.0.3.md
│   └── ...
├── data/                 # Данные приложения (создается автоматически)
│   ├── core/             # Ядро SingBox
│   ├── logs/             # Логи
│   ├── locales/          # Файлы локализации (копируются из locales/)
│   ├── .version          # Файл версии (копируется из корня при сборке)
│   └── config.json       # Конфиг
├── SingBox-UI.spec       # Конфигурация PyInstaller для основного приложения
├── updater.spec          # Конфигурация PyInstaller для updater
└── requirements.txt      # Зависимости
```

## Управление версией

Версия приложения хранится в файле `.version` в корне проекта. При сборке этот файл копируется в `data/.version`, откуда приложение читает версию при запуске.

Функция `get_version()` в `main/main.py`:
1. Сначала пытается прочитать `data/.version` (для собранного приложения)
2. Затем пытается прочитать корневой `.version` (для разработки)
3. В случае ошибки использует fallback версию "1.0.0"

При CI/CD сборке по тегу, версия в `.version` должна обновляться автоматически, если тег больше текущей версии.

## Модули

### main/
- **main.py** - Главный файл приложения
  - Функция `get_version()` - чтение версии из файла
  - Класс `MainWindow` - главное окно приложения
  - Управление страницами, подписками, запуском/остановкой SingBox
  
- **updater.py** - Утилита обновления
  - GUI окно updater в стиле приложения
  - Поток для выполнения обновления
  - Скачивание обновления с GitHub
  - Установка обновления с защитой пользовательских данных
  
- **post_build.py** - Скрипт пост-обработки сборки
  - Организация файлов после сборки
  - Копирование локалей, иконок, .version файла
  - Создание структуры папок

### icons/
- **icon.ico** - Иконка Windows (используется в exe и трее)
- **icon.png** - PNG версия иконки (fallback)
- **icon.svg** - Исходная SVG иконка

### scripts/
- **register_protocol.py** - Скрипт регистрации протоколов
  - Регистрация `sing-box://` и `singbox-ui://` в Windows
  - Требует прав администратора

### config/
- **paths.py** - Определение всех путей к файлам и директориям
- Функция `ensure_dirs()` - создание необходимых папок

### managers/
- **settings.py** - Управление настройками приложения
  - Сохранение/загрузка настроек
  - Поддержка языка интерфейса
  
- **subscriptions.py** - Управление подписками
  - CRUD операции с подписками
  - Скачивание конфигов

- **log_ui_manager.py** - Управление логами в UI
  - Класс `LogUIManager` - централизованное управление отображением логов
  - Метод `load_logs_to_ui()` - загрузка основных логов из файла в QTextEdit
  - Метод `load_debug_logs_from_file_to_ui()` - загрузка debug логов
  - Метод `refresh_logs_from_files()` - автоматическое обновление логов каждую секунду
  - Метод `cleanup_logs_if_needed()` - очистка логов раз в сутки
  - Метод `append_log_to_ui()` - добавление новой строки лога в UI
  - Метод `_auto_scroll_if_needed()` - автоматическая прокрутка логов
  - Метод `on_scroll_value_changed()` - обработка ручной прокрутки (остановка автоскролла)
  - Метод `_resume_auto_scroll()` - возобновление автоскролла после 5 секунд бездействия
  - Метод `update_debug_logs_visibility()` - управление видимостью debug логов

### utils/
- **i18n.py** - Система локализации
  - Класс `Translator` для работы с переводами
  - Функция `tr()` для получения переводов
  - Поддержка форматирования строк
  - Поддержка пользовательских языков через `_language_name` в файлах локализации
  
- **logger.py** - Система логирования
  - Запись логов в файлы
  - Отладочные логи
  
- **singbox.py** - Утилиты для SingBox
  - Получение версии SingBox
  - Проверка обновлений SingBox и приложения

### core/
- **protocol.py** - Регистрация протоколов и работа с правами администратора
  - Функция `register_protocols()` - регистрация deep link протоколов
  - Функция `is_admin()` - проверка прав администратора
  - Функция `restart_as_admin()` - перезапуск с правами администратора

- **singbox_manager.py** - Управление процессом SingBox
  - Класс `SingBoxManager` - управление жизненным циклом процесса
  - Класс `StartSingBoxWorker` - поток для запуска SingBox

- **deep_link_handler.py** - Обработчик deep links
  - Класс `DeepLinkHandler` - обработка протоколов sing-box:// и singbox-ui://
  - Метод `handle()` - основной метод обработки аргументов командной строки
  - Поддержка протоколов: `sing-box://`, `singbox-ui://`, `http://`, `https://`
  - Автоматическая нормализация URL (добавление https:// если отсутствует)
  - Извлечение имени подписки из URL (из fragment или домена)
  - Проверка на дубликаты подписок перед добавлением
  - Импорт подписок с показом информационных диалогов
  - Обработка ошибок при импорте с показом предупреждений

### app/
- **application.py** - Инициализация приложения
  - Функция `create_application()` - создание и настройка QApplication
  - Функция `apply_dark_theme()` - применение темной темы

### workers/
- **base_worker.py** - Базовый класс для фоновых потоков
  - Класс `BaseWorker` - обертка над QThread с сигналами finished/error

- **init_worker.py** - Воркер инициализации
  - Класс `InitOperationsWorker` - загрузка подписок, проверка версий, очистка логов

- **version_worker.py** - Воркеры проверки версий
  - Класс `CheckVersionWorker` - проверка версии SingBox
  - Класс `CheckAppVersionWorker` - проверка версии приложения

### ui/pages/
- **base_page.py** - Базовый класс для всех страниц
  - Класс `BasePage` - предоставляет общий layout и метод `add_card()`

- **profile_page.py** - Страница управления профилями
  - Список подписок
  - Кнопки управления (добавить, удалить, переименовать, тест)

- **home_page.py** - Главная страница
  - Отображение версии SingBox
  - Информация о профиле
  - Статус администратора
  - Большая кнопка Start/Stop

- **settings_page.py** - Страница настроек
  - Настройки приложения (автозапуск, интервал обновления, язык)
  - Логи (обычные и debug)
  - Debug секция (скрыта по умолчанию)

### ui/widgets/
- **card.py** - Виджет-карточка с фоном и скругленными углами
- **nav_button.py** - Кнопка навигации с иконкой и текстом
- **version_label.py** - Лейбл для отображения версии

### ui/styles/
- **constants.py** - Константы UI (цвета, шрифты, размеры, переходы)
- **theme.py** - Управление темой приложения
  - Класс `Theme` - централизованное управление темой
  - Глобальный экземпляр `theme`
- **stylesheet.py** - Генерация стилей для виджетов
  - Класс `StyleSheet` - статические методы для генерации CSS стилей

### ui/dialogs/
- **base_dialog.py** - Базовый класс для диалогов
  - Функция `create_dialog()` - универсальная фабрика диалогов
  - Enum `DialogType` - типы диалогов (INFO, CONFIRM, WARNING, SUCCESS)

- **confirm_dialog.py** - Диалоги подтверждения
  - Функция `show_confirm_dialog()` - универсальный диалог подтверждения
  - Функция `show_restart_admin_dialog()` - диалог перезапуска от админа
  - Функция `show_kill_all_confirm_dialog()` - диалог подтверждения остановки процессов

- **info_dialog.py** - Информационные диалоги
  - Функция `show_info_dialog()` - универсальный информационный диалог
  - Функция `show_kill_all_success_dialog()` - диалог успешной остановки процессов

- **language_dialog.py** - Диалог выбора языка
  - Функция `show_language_selection_dialog()` - диалог выбора языка при первом запуске

### ui/
- **tray_manager.py** - Менеджер системного трея
  - Класс `TrayManager` - управление созданием, настройкой и удалением иконки в трее
  - Метод `setup()` - инициализация иконки трея с контекстным меню
  - Метод `_get_tray_icon()` - загрузка иконки из различных источников (exe, ico, png)
  - Метод `_show_main_window()` - показ и активация главного окна
  - Метод `_tray_icon_activated()` - обработка активации иконки (двойной клик)
  - Метод `_quit_application()` - корректное завершение приложения
  - Метод `show_message()` - показ уведомлений через системный трей
  - Метод `cleanup()` - очистка ресурсов при закрытии приложения

## Использование локализации

```python
from utils.i18n import tr, set_language

# Получить перевод
text = tr("home.version")  # "Версия SingBox"

# С параметрами
text = tr("home.installed", version="1.8.0")  # "Установлено: версия 1.8.0"

# Изменить язык
set_language("en")  # Переключить на английский
```

## Добавление нового языка

1. Создайте файл `data/locales/xx.json` (где xx - код языка, например `eng2.json`)
2. Скопируйте структуру из `ru.json` или `en.json`
3. Добавьте поле `"_language_name"` в корень JSON с названием языка (например, `"_language_name": "English (Custom)"`)
4. Переведите все строки
5. Язык будет доступен автоматически в настройках

## Преимущества архитектуры

1. **Модульность** - код разделен на логические модули
2. **Разделение ответственности** - каждый модуль отвечает за свою область
3. **Переиспользуемость** - общие компоненты вынесены в отдельные модули
4. **Централизация стилей** - единая система стилей через `ui/styles/`
5. **Локализация** - легко добавлять новые языки
6. **Расширяемость** - легко добавлять новые функции
7. **Поддерживаемость** - проще находить и исправлять ошибки
8. **Тестируемость** - модули можно тестировать отдельно
9. **Отзывчивость** - тяжелые операции вынесены в фоновые потоки

## Сборка проекта

### Требования
- Python 3.8+
- PyInstaller 6.0+

### Команда сборки
```bash
# Сборка основного приложения
py -m PyInstaller SingBox-UI.spec --clean --noconfirm

# Сборка updater
py -m PyInstaller updater.spec --clean --noconfirm

# Пост-обработка
py main/post_build.py
```

### Результат сборки
После сборки в папке `dist/SingBox-UI/` будет:
- `SingBox-UI.exe` - главный исполняемый файл
- `data/locales/` - файлы локализации
- `data/core/` - ядро SingBox (если было включено)
- `data/updater.exe` - утилита обновления
- `data/.version` - файл версии приложения

## Разработка

### Запуск в режиме разработки
```bash
python main/main.py
```

### Структура данных
Все данные приложения хранятся в папке `data/`:
- `data/core/sing-box.exe` - ядро SingBox (не обновляется автоматически)
- `data/logs/` - логи приложения
  - `singbox.log` - логи SingBox
  - `debug.log` - отладочные логи
- `data/locales/` - файлы локализации (обновляются, пользовательские сохраняются)
- `data/config.json` - конфигурация SingBox (скачивается из подписки)
- `data/.subscriptions` - список подписок (JSON, сохраняется при обновлениях)
- `data/.settings` - настройки приложения (JSON, объединяются при обновлениях)
- `data/.version` - версия приложения (копируется из корня при сборке)
- `data/updater.exe` - утилита обновления (обновляется при обновлениях)

### Система обновлений
- Updater (`main/updater.py`) - отдельное приложение с GUI
- Выполняет весь процесс обновления: скачивание, установка, перезапуск
- Защищает пользовательские данные: подписки, настройки, ядро, логи
- Объединяет настройки: новые ключи добавляются, существующие сохраняются

## Архитектурные решения

### Разделение UI на страницы
Все UI страницы вынесены в отдельные классы в `ui/pages/`:
- Каждая страница наследуется от `BasePage`
- Страницы управляются через `QStackedWidget` в `MainWindow`
- Доступ к элементам страниц через `self.page_profile`, `self.page_home`, `self.page_settings`

### Разделение функциональности на менеджеры
Для уменьшения размера `main/main.py` и улучшения архитектуры, функциональность вынесена в отдельные менеджеры:
- **TrayManager** (`ui/tray_manager.py`) - управление системным треем
- **LogUIManager** (`managers/log_ui_manager.py`) - управление отображением логов в UI
- **DeepLinkHandler** (`core/deep_link_handler.py`) - обработка deep links и импорт подписок

### Централизованная система стилей
Все стили централизованы в `ui/styles/`:
- Константы (цвета, шрифты, размеры) в `constants.py`
- Управление темой через `Theme` в `theme.py`
- Генерация стилей через `StyleSheet` в `stylesheet.py`

### Фоновые потоки
Тяжелые операции вынесены в фоновые потоки через систему воркеров:
- `BaseWorker` - базовый класс для всех воркеров
- `InitOperationsWorker` - инициализация при старте
- `CheckVersionWorker` / `CheckAppVersionWorker` - проверка версий

### Переиспользуемые компоненты
Общие UI компоненты вынесены в `ui/widgets/`:
- `CardWidget` - карточка с фоном
- `NavButton` - кнопка навигации
- `VersionLabel` - лейбл версии

### Уменьшение размера main.py
Для улучшения поддерживаемости и читаемости кода, из `main/main.py` были вынесены:
- **Управление треем** → `ui/tray_manager.py` (класс `TrayManager`)
  - Методы `setup_tray()`, `tray_icon_activated()`, `quit_application()` и связанная логика
- **Управление логами в UI** → `managers/log_ui_manager.py` (класс `LogUIManager`)
  - Методы `load_logs()`, `refresh_logs_from_files()`, `cleanup_logs_if_needed()`, `log()` и связанная логика
- **Обработка deep links** → `core/deep_link_handler.py` (класс `DeepLinkHandler`)
  - Метод `handle_deep_link()` и вся логика парсинга URL и импорта подписок

Текущий размер `main/main.py`: ~2127 строк (было значительно больше до рефакторинга)

